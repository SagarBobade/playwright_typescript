<table>
    <thead>
        <tr>
            <th>Test ID</th>
            <th>Feature</th>
            <th>Priority</th>
            <th>Tags</th> <th>Status</th>
            <th>Known Bug</th>
            <th>Type</th>
        </tr>
    </thead>
    <tbody id="test-table-body">
        </tbody>
</table>

<script>
    async function loadDashboard() {
        try {
            // 1. Fetch JSON Stats (KPIs)
            const statsRes = await fetch('./summary-stats.json');
            const stats = await statsRes.json();
            
            document.getElementById('total-tests').innerText = stats.totalManifested;
            document.getElementById('automated-count').innerText = stats.automated;
            document.getElementById('coverage-percent').innerText = stats.testCoverage;

            if (stats.shadowTestsCount > 0) {
                document.getElementById('shadow-alert').style.display = 'block';
                document.getElementById('shadow-list').innerText = stats.shadowTestsList.join(', ');
            }

            // 2. Fetch and Parse YAML (Detailed Manifest)
            const yamlRes = await fetch('./tests.yaml');
            const yamlText = await yamlRes.text();
            const tests = jsyaml.load(yamlText);

            const tableBody = document.getElementById('test-table-body');
            tableBody.innerHTML = ''; // Clear existing content

            tests.forEach(test => {
                // Logic to handle tags and turn them into small badges
                const tagHtml = (test.tags || [])
                    .map(tag => `<span style="background:#eee; padding:2px 6px; border-radius:10px; font-size:10px; margin-right:4px; border:1px solid #ddd;">${tag}</span>`)
                    .join('');

                const row = `
                    <tr>
                        <td><strong>${test.test_id}</strong></td>
                        <td>${test.feature}</td>
                        <td><span class="priority-label">${test.priority}</span></td>
                        <td>${tagHtml}</td>
                        <td style="color: ${test.last_status === 'Passed' ? '#27ae60' : '#e74c3c'}; font-weight:bold;">
                            ${test.last_status}
                        </td>
                        <td>
                            ${test.known_bug_id ? `<a href="YOUR_JIRA_URL/${test.known_bug_id}" target="_blank" style="color:#3498db; text-decoration:none;">${test.known_bug_id}</a>` : '-'}
                        </td>
                        <td>
                            <span class="status-pill ${test.isAutomated ? 'automated' : 'manual'}">
                                ${test.isAutomated ? 'AUTOMATED' : 'PLANNED'}
                            </span>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (err) {
            console.error("Failed to load dashboard data:", err);
            document.body.innerHTML += `<p style="color:red; padding:20px;">Error loading data. Check if tests.yaml and summary-stats.json exist in the root folder.</p>`;
        }
    }

    loadDashboard();
</script>